From 226b46770c82899b555986583294b049c6ec9b40 Mon Sep 17 00:00:00 2001
From: Florian Weimer <fweimer@redhat.com>
Date: Mon, 17 Jan 2022 10:21:34 +0100
Subject: [PATCH] CVE-2022-23219: Buffer overflow in sunrpc clnt_create for
 "unix" (bug 22542)

Processing an overlong pathname in the sunrpc clnt_create function
results in a stack-based buffer overflow.

Reviewed-by: Siddhesh Poyarekar <siddhesh@sourceware.org>

Helmut Grohne: Ported to glibc 2.28. Inlined __sockaddr_un_set.

--- a/sunrpc/clnt_gen.c
+++ b/sunrpc/clnt_gen.c
@@ -57,9 +57,17 @@ clnt_create (const char *hostname, u_long prog, u_long vers,
 
   if (strcmp (proto, "unix") == 0)
     {
-      __bzero ((char *)&sun, sizeof (sun));
+      size_t name_length = strlen(hostname);
+      if (name_length >= sizeof(sun.sun_path))
+	{
+	  struct rpc_createerr *ce = &get_rpc_createerr ();
+	  ce->cf_stat = RPC_SYSTEMERROR;
+	  __set_errno (EINVAL);     /* Error code used by the kernel.  */
+	  ce->cf_error.re_errno = errno;
+	  return NULL;
+	}
       sun.sun_family = AF_UNIX;
-      strcpy (sun.sun_path, hostname);
+      memcpy(sun.sun_path, hostname, name_length + 1);
       sock = RPC_ANYSOCK;
       client = clntunix_create (&sun, prog, vers, &sock, 0, 0);
       if (client == NULL)
